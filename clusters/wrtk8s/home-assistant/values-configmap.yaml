apiVersion: v1
kind: ConfigMap
metadata:
  name: home-assistant-values
  namespace: home-assistant
data:
  values.yaml: |
    persistence:
      enabled: true
    service:
      type: ClusterIP
    extraVolumes:
      - name: http-config
        configMap:
          name: home-assistant-http-config
    extraVolumeMounts:
      - name: http-config
        mountPath: /config/http.yaml
        subPath: http.yaml
    initContainers:
      - name: inject-http-config
        image: busybox
        command:
          - /bin/sh
          - -c
          - |
            if ! grep -q "http: !include http.yaml" /config/configuration.yaml 2>/dev/null; then
              echo "http: !include http.yaml" >> /config/configuration.yaml
            fi
        volumeMounts:
          - name: home-assistant
            mountPath: /config
