cluster:
  inlineManifests:
    - name: kube-proxy
      contents: |
        ---
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: kube-proxy
          namespace: kube-system
          labels:
            k8s-app: kube-proxy
            tier: node
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: kube-proxy
          labels:
            k8s-app: kube-proxy
            tier: node
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: system:node-proxier
        subjects:
          - kind: ServiceAccount
            name: kube-proxy
            namespace: kube-system
        ---
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: kube-proxy
          namespace: kube-system
          labels:
            k8s-app: kube-proxy
            tier: node
        data:
          config.conf: |
            apiVersion: kubeproxy.config.k8s.io/v1alpha1
            kind: KubeProxyConfiguration
            mode: nftables
            clusterCIDR: 10.244.0.0/16
            metricsBindAddress: 0.0.0.0:10249
            conntrack:
              maxPerCore: 0
        ---
        apiVersion: apps/v1
        kind: DaemonSet
        metadata:
          name: kube-proxy
          namespace: kube-system
          labels:
            k8s-app: kube-proxy
            tier: node
        spec:
          selector:
            matchLabels:
              k8s-app: kube-proxy
              tier: node
          template:
            metadata:
              labels:
                k8s-app: kube-proxy
                tier: node
            spec:
              priorityClassName: system-node-critical
              serviceAccountName: kube-proxy
              hostNetwork: true
              tolerations:
                - operator: Exists
                  effect: NoSchedule
                - operator: Exists
                  effect: NoExecute
              containers:
                - name: kube-proxy
                  image: registry.k8s.io/kube-proxy:v1.35.1
                  command:
                    - /usr/local/bin/kube-proxy
                    - --config=/var/lib/kube-proxy/config.conf
                    - --hostname-override=$(NODE_NAME)
                  env:
                    - name: NODE_NAME
                      valueFrom:
                        fieldRef:
                          fieldPath: spec.nodeName
                    - name: KUBERNETES_SERVICE_HOST
                      value: "127.0.0.1"
                    - name: KUBERNETES_SERVICE_PORT
                      value: "7445"
                  securityContext:
                    privileged: true
                  volumeMounts:
                    - name: kube-proxy
                      mountPath: /var/lib/kube-proxy
                    - name: xtables-lock
                      mountPath: /run/xtables.lock
                    - name: lib-modules
                      mountPath: /lib/modules
                      readOnly: true
              volumes:
                - name: kube-proxy
                  configMap:
                    name: kube-proxy
                - name: xtables-lock
                  hostPath:
                    path: /run/xtables.lock
                    type: FileOrCreate
                - name: lib-modules
                  hostPath:
                    path: /lib/modules
